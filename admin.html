<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ-панель</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script async src="https://telegram.org/js/telegram-widget.js?22"
    data-telegram-login="driverearnrank_bot"
    data-size="large"
    data-userpic="false"
    data-request-access="write"
    data-on-auth="onTelegramAuth">
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 20px; }
    .order { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .status { font-weight: bold; color: green; }
    select { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Админка (авторизация через Telegram)</h2>
  <div id="panel"></div>

  <script>
    function onTelegramAuth(user) {
      const allowed = [799869557, 565652402];
      if (!allowed.includes(user.id)) {
        document.getElementById("panel").innerHTML = "<p>⛔ Доступ запрещён</p>";
        return;
      }
      loadOrders();
    }

    function loadOrders() {
      fetch("/admin/orders").then(res => res.json()).then(data => {
        const panel = document.getElementById("panel");
        panel.innerHTML = "";
        data.forEach((order, i) => {
          const div = document.createElement("div");
          div.className = "order";
          div.innerHTML = `
            <strong>@${order.username}</strong><br>
            <span class="status">Статус: ${order.status}</span><br>
            <small>${order.timestamp}</small><br>
            <ul>${order.cart.map(item => `<li>${item}</li>`).join("")}</ul>
            <select onchange="updateStatus(${i}, this.value)">
              <option value="ожидает">ожидает</option>
              <option value="оплачен">оплачен</option>
              <option value="отменён">отменён</option>
            </select>
          `;
          panel.appendChild(div);
        });
      });
    }

    function updateStatus(index, status) {
      fetch('/admin/update_status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index, status })
      }).then(() => loadOrders());
    }
  </script>
</body>
</html>
