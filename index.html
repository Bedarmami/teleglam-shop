<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–∞–≥–∞–∑–∏–Ω</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; background: #f2f4f8; margin: 0; padding: 0; }
    .tabs { display: flex; background: white; border-bottom: 1px solid #ccc; }
    .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; }
    .tab.active { background: #4a90e2; color: #fff; font-weight: bold; }
    .products, .profile { padding: 15px; }
    .card { width: 150px; background: white; border-radius: 10px; padding: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin: 5px auto; }
    .card img { width: 100px; height: 100px; object-fit: contain; }
    .btn { margin-top: 8px; background: #4a90e2; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .profile-order { background: #fff; margin-bottom: 10px; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="showTab('shop')">üõí –¢–æ–≤–∞—Ä—ã</div>
    <div class="tab" onclick="showTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>
  <div id="shopTab" class="products"></div>
  <div id="profileTab" class="profile" style="display:none"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let allProducts = [];
    const user = tg.initDataUnsafe?.user || {};
    const userId = user.id;

    fetch("/products.json")
      .then(res => res.json())
      .then(data => {
        allProducts = data;
        renderProducts();
      });

    function renderProducts() {
      const el = document.getElementById("shopTab");
      el.innerHTML = "";
      allProducts.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.img}" />
          <div>${p.name}</div>
          <div><b>${p.price} z≈Ç</b></div>
          <button class="btn" onclick='addToCart(${JSON.stringify(p)})'>–í –∫–æ—Ä–∑–∏–Ω—É</button>
        `;
        el.appendChild(card);
      });
    }

    const cart = {};
    function addToCart(p) {
      if (cart[p.id]) cart[p.id].qty += 1;
      else cart[p.id] = { ...p, qty: 1 };
      tg.showAlert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É: " + p.name);
    }

    function showTab(tab) {
      document.getElementById("shopTab").style.display = tab === "shop" ? "block" : "none";
      document.getElementById("profileTab").style.display = tab === "profile" ? "block" : "none";
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab")[tab === "shop" ? 0 : 1].classList.add("active");

      if (tab === "profile") loadProfile();
    }

    function loadProfile() {
      const el = document.getElementById("profileTab");
      el.innerHTML = "<b>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</b>";
      fetch("/profile/" + userId)
        .then(res => res.json())
        .then(data => {
          if (!data.length) return el.innerHTML = "<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>";
          el.innerHTML = "<h3>–í–∞—à–∏ –∑–∞–∫–∞–∑—ã</h3>";
          data.reverse().forEach(o => {
            const div = document.createElement("div");
            div.className = "profile-order";
            div.innerHTML = `
              <div><b>–°—Ç–∞—Ç—É—Å:</b> ${o.status}</div>
              <div><b>–î–∞—Ç–∞:</b> ${o.timestamp}</div>
              <div><b>–¢–æ–≤–∞—Ä—ã:</b><br> ${o.cart.map(c => `<div>${c}</div>`).join("")}</div>
            `;
            el.appendChild(div);
          });
        });
    }

    function submitCart() {
      const cartItems = Object.values(cart).map(i => `${i.name} (${i.qty}√ó${i.price} z≈Ç)`);
      fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId || null,
          username: user.username || "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω",
          cart: cartItems
        })
      }).then(() => {
        tg.showAlert("‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.");
        Object.keys(cart).forEach(k => delete cart[k]);
      });
    }

    tg.MainButton.setText("–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑");
    tg.MainButton.show();
    tg.MainButton.onClick(submitCart);
  </script>

<div id="cartModal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; max-height:80%; overflow:auto;">
    <h3>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h3>
    <div id="cartItemsList"></div>
    <div style="margin-top:10px;" id="cartTotal"></div>
    <button onclick="submitCart()" class="btn">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button onclick="hideCart()" class="btn" style="background:#ccc; color:#000; margin-top:5px;">üîô –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
  </div>
</div>
<script>
function showCart() {
  const list = document.getElementById("cartItemsList");
  const totalEl = document.getElementById("cartTotal");
  let total = 0;
  list.innerHTML = "";
  Object.values(cart).forEach(i => {
    total += i.qty * i.price;
    const item = document.createElement("div");
    item.innerText = `${i.name} (${i.qty}√ó${i.price} z≈Ç)`;
    list.appendChild(item);
  });
  totalEl.innerText = "–ò—Ç–æ–≥–æ: " + total + " z≈Ç";
  document.getElementById("cartModal").style.display = "flex";
}
function hideCart() {
  document.getElementById("cartModal").style.display = "none";
}
tg.MainButton.setText("üõí –ö–æ—Ä–∑–∏–Ω–∞");
tg.MainButton.show();
tg.MainButton.onClick(showCart);
</script>
</body>

</html>
